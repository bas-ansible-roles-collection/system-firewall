---
# Tests firewalls are configured correctly by attempting to connect on various ports

# Note: Hosts are hard coded here to test against their enabled firewall services,
# there is likely a much better way to do this which I will happy adopt in future versions.

- name: test if firewall services that should be contactable on both CentOS and Ubuntu are contactable
  shell: "nmap -p {{ item.port }} barc-system-firewall-test-ubuntu-bare.v.m barc-system-firewall-test-centos-bare.v.m | grep -c open"
  with_items: system_firewall_rules
  when: item.port is defined and
    item.name_firewalld is defined and item.name_ufw is defined and
    (item.state_firewalld is not defined or
        (item.state_firewalld is defined and item.state_firewalld == 'enabled') or
    item.state_ufw is not defined or
        (item.state_ufw is defined and item.state_ufw == 'no')
    )
  changed_when: false
  register: system_ssh_test_nmap_firewall_services_enabled_all_os
- name: assert firewall services that should be contactable on both CentOS and Ubuntu are contactable
  assert:
    that: "'2' in item.1.stdout"
  with_together:
    - system_firewall_rules
    - system_ssh_test_nmap_firewall_services_enabled_all_os.results
  when: item.0.port is defined and
    item.0.name_firewalld is defined and item.0.name_ufw is defined and
    (item.0.state_firewalld is not defined or
        (item.0.state_firewalld is defined and item.0.state_firewalld == 'enabled') or
    item.0.state_ufw is not defined or
        (item.0.state_ufw is defined and item.0.state_ufw == 'no')
    )

- name: test if firewall services that should be contactable on CentOS only are contactable
  shell: "nmap -p {{ item.port }} barc-system-firewall-test-centos-bare.v.m | grep -c open"
  with_items: system_firewall_rules
  when: item.port is defined and item.name_firewalld is defined and item.name_ufw is not defined and
    item.state_firewalld is not defined or (item.state_firewalld is defined and item.state_firewalld == 'enabled')
  changed_when: false
  register: system_ssh_test_nmap_firewall_services_enabled_centos
