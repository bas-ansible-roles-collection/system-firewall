---
# Setup infrastructure for testing role

# Apply role to test VMs,
# host-vars are used to control which features of the role are applied to each VM.
# For each test a set of tasks will be run to check the selected features of roles are correctly applied.

# Functional tests are currently disabled due to difficulties in testing the status of a port without a service
# listening on each port.

- name: prepare nodes with additional firewall applications for testing - Ubuntu/UFW
  hosts: barc-system-firewall-test-ubuntu-bare.v.m
  remote_user: controller
  become: yes
  tasks:
    - include: host_tasks/barc-system-firewall-test-ubuntu-bare.v.m.yml

- name: prepare port test machine for functional testing
  hosts: barc-system-firewall-test-port-test.v.m
  remote_user: controller
  become: yes
  tasks:
    - include: tasks/test-firewall-applications-ubuntu-ufw.yml

- name: setup and test the system firewall role
  hosts: barc-system-firewall-test-nodes
  remote_user: controller
  become: yes
  roles:
    - ../../../system-firewall
  tasks:
    - name: flush handlers to apply firewall changes before testing
      meta: flush_handlers
    - include: ../tasks/main.yml

- name: perform functionality checks for this role on an external port testing machine
  hosts: barc-system-firewall-test-port-test.v.m
  remote_user: controller
  become: yes
  vars_files:
    - group_vars/barc-system-firewall-test-bare.yml
  tasks: []
