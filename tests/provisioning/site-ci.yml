---
# Setup infrastructure for testing role

# Apply role to test VMs,
# host-vars are used to control which features of the role are applied to each VM.
# For each test a set of tasks will be run to check the selected features of roles are correctly applied.

# Note: The 'port' option is not supported by the system firewall role, it used exclusively for testing.

- name: setup and test the system firewall role
  hosts: local
  become: yes
  vars:
    system_firewall_rules:
      -
        name_firewalld: ssh
        name_ufw: OpenSSH
        port: 22
      -
        name_firewalld: http
        state_firewalld: disabled
        port: 80
      -
        name_firewalld: https
        permanent: True
        state_firewalld: enabled
        port: 443
      -
        name_ufw: http-test
        state_ufw: 'yes'
        port: 80
      -
        name_ufw: https-test
        rule: deny
        state_ufw: 'no'
        port: 443
  pre_tasks:
    - name: copy test firewall application for http
      command: cp data/firewall-profiles/http-test /etc/ufw/applications.d/http-test
      changed_when: false
    - name: register firewall application for http with UFW
      command: ufw app update http-test
      changed_when: false
    - name: copy test firewall application for https
      command: cp data/firewall-profiles/https-test /etc/ufw/applications.d/https-test
      changed_when: false
    - name: register firewall application for https with UFW
      command: ufw app update https-test
      changed_when: false
  roles:
    - ~/system-firewall
  tasks:
    - include: ../tasks/main.yml
